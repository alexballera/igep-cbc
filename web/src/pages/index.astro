---
import Layout from '../layouts/Layout.astro';
import SessionCard from '../components/SessionCard.astro';

// Buscamos todos los archivos de resumen DENTRO de la carpeta 'public'
// Astro los servirá automáticamente en la raíz del sitio.
const allSummaries = await Astro.glob('../../public/sesiones/sesion*/**/resumenes/*');

// Agrupamos los resúmenes por sesión
const sessions = allSummaries.reduce((acc, summary) => {
  // Extrae 'sesion1', 'sesion2', etc.
  const sessionPath = summary.file.split('/').find(part => part.startsWith('sesion'));
  if (!sessionPath) return acc;
  
  const sessionNumber = sessionPath.replace('sesion', '');
  
  if (!acc[sessionNumber]) {
    acc[sessionNumber] = {
      number: sessionNumber,
      files: []
    };
  }

  // Construimos la URL. Astro.glob nos da la ruta del sistema de archivos.
  // Necesitamos una ruta relativa a la carpeta 'public'.
  // Ejemplo: de '/path/to/project/web/public/sesiones/s1/resumen.pdf'
  // a '/sesiones/s1/resumen.pdf'
  const urlPath = '/' + summary.file.split('/public/')[1];
  const fileName = summary.file.split('/').pop();

  acc[sessionNumber].files.push({
    path: urlPath,
    name: fileName
  });
  return acc;
}, {});

const sessionList = Object.values(sessions).sort((a, b) => a.number - b.number);
---

<Layout title="IGEP - Material de Estudio">
  <main>
    <h1>Material de Estudio de IGEP</h1>
    <p>Recopilación de resúmenes, audios y videos de cada sesión.</p>
    <div class="card-grid">
      {sessionList.map(session => (
        <SessionCard 
          sessionNumber={session.number}
          files={session.files}
        />
      ))}
    </div>
  </main>
</Layout>